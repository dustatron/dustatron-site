---
// This is a server-side script that will run during build
// We're not using it for now, but it's here for future use if needed
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 650px;
        margin: 0 auto;
        padding: 2rem;
        text-align: center;
      }
      .card {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 2rem;
      }
      .success {
        color: #38a169;
      }
      .error {
        color: #e53e3e;
      }
      .loading {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #3182ce;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>GitHub Authentication</h1>
      <div class="card">
        <div id="loading" class="loading"></div>
        <div id="message">
          <h2>Authenticating with GitHub...</h2>
          <p>Please wait while we complete the authentication process.</p>
        </div>
      </div>
    </div>

    <script>
      // This script handles the OAuth callback from GitHub
      document.addEventListener("DOMContentLoaded", function () {
        const searchParams = new URLSearchParams(window.location.search);
        const code = searchParams.get("code");
        const provider = searchParams.get("provider");
        const messageEl = document.getElementById("message");
        const loadingEl = document.getElementById("loading");

        if (code && provider) {
          // For Decap CMS with GitHub backend, we need to redirect back to the admin page
          // with the auth code in the hash
          const adminUrl =
            window.location.origin +
            (window.location.hostname === "localhost"
              ? ""
              : "/dustatron-site") +
            "/admin/#";

          // Create the hash parameters
          const hashParams = new URLSearchParams();
          hashParams.set("provider", provider);
          hashParams.set("code", code);

          // Redirect to the admin page with the hash parameters
          window.location.href = adminUrl + hashParams.toString();
        } else {
          // If there's no code or provider, show an error
          if (loadingEl) {
            loadingEl.style.display = "none";
          }

          if (messageEl) {
            messageEl.innerHTML = `
              <h2 class="error">Authentication Error</h2>
              <p>We couldn't complete the authentication process. Please try again.</p>
              <p>Missing required parameters: ${!code ? "code" : ""} ${!provider ? "provider" : ""}</p>
              <p><a href="../admin/">Return to admin</a></p>
            `;
          }
        }
      });
    </script>
  </body>
</html>
